\documentclass[10pt,a4paper]{article}
\usepackage[margin=.5in]{geometry}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{dot2texi}
\usepackage{tikz}
\usetikzlibrary{shapes,arrows}\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{verbatim}
\usepackage{listings}
\usepackage{color}
\usepackage{parskip}
\usepackage{float}
\usepackage{mathtools}
% \usepackage{minted}
\usepackage{verbatim}
\usepackage{listings}
\usepackage{optidef}
\usepackage{bm}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{hyperref}
\usepackage{cleveref}
\usepackage{enumerate}
\restylefloat{figure}
% \setminted{fontsize=\tiny,linenos=true,frame=single,breaklines=true}
\allowdisplaybreaks

\algrenewcommand{\Return}{\State\algorithmicreturn~}
\DeclareMathOperator*{\argmin}{arg\,min}

\title{IPM forumalations for thesis}
\author{Pratyai Mazumder}

\renewcommand{\thesubsection}{\thesection.\roman{subsection}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\Rgz}{\R_{>0}}
\newcommand{\Rgez}{\R_{\geq0}}
\newcommand{\Rlz}{\R_{<0}}
\newcommand{\Rlez}{\R_{\leq0}}

\begin{document}

\maketitle

\section{Original Problem}

\subsection{Primal}

\begin{mini}|s|
{\mathbf{x}}{\mathbf{c}^T\mathbf{x}}{}{}
\addConstraint{\mathbf{A}\mathbf{x}}{= \mathbf{b}}
\addConstraint{\mathbf{x}}{\leq \bm{u}}
\addConstraint{\mathbf{x}}{\in \Rgez^m}
\end{mini}

\subsection{Primal Standard Form}

\begin{mini}|s|
{\mathbf{x}}{\mathbf{c}^T\mathbf{x}}{}{}
\addConstraint{\mathbf{A}\mathbf{x}}{= \mathbf{b}}
\addConstraint{\mathbf{x} + \mathbf{x}_u}{= \bm{u}}
\addConstraint{\mathbf{x}, \mathbf{x}_u}{\in \Rgez^m, \Rgez^m}
\end{mini}

\subsection{Dual}

\begin{maxi}|s|
{\mathbf{y}, \mathbf{y}_u}{\mathbf{b}^T\mathbf{y} - \mathbf{u}^T\mathbf{y}_u}{}{}
\addConstraint{\mathbf{A}^T\mathbf{y} - \mathbf{y}_u}{\leq \mathbf{c}}
\addConstraint{\mathbf{y}, \mathbf{y}_u}{\in \R^n, \Rgez^m}
\end{maxi}

\subsection{Dual Standard form}

\begin{maxi}|s|
{\mathbf{y}, \mathbf{y}_u}{\mathbf{b}^T\mathbf{y} - \mathbf{u}^T\mathbf{y}_u}{}{}
\addConstraint{\mathbf{A}^T\mathbf{y} + \mathbf{y}_u + \mathbf{z}}{= \mathbf{c}}
\addConstraint{\mathbf{y}, \mathbf{y}_u, \mathbf{z}}{\in \R^n, \Rgez^m, \Rgez^m}
\end{maxi}

But if we want $\mathbf{y}$ variables to be free, then dualize the standard from, then standardize again:
\begin{maxi}|s|
{\mathbf{y}, \mathbf{y}_u}{\mathbf{b}^T\mathbf{y} + \mathbf{u}^T\mathbf{y}_u}{}{}
\addConstraint{\mathbf{A}^T\mathbf{y} + \mathbf{y}_u + \mathbf{z}_1}{= \mathbf{c}}
\addConstraint{\mathbf{y}_u + \mathbf{z}_2}{= \bm{0}}
\addConstraint{\mathbf{y}, \mathbf{y}_u, \mathbf{z}_1, \mathbf{z}_2}{\in \R^n, \R^m, \Rgez^m, \Rgez^m}
\end{maxi}

\section{Solver Forms}

\subsection{Long Step Path Following Method}

Ref: \href{https://link.springer.com/book/10.1007/978-0-387-40065-5}{Numerical Optimization (Alg. 14.2)}

Due to the formulation, we have to work with the standard form.

\subsubsection{Primal}

\begin{mini}|s|
{}{c^Tx}{}{}
\addConstraint{Ax}{= b}
\addConstraint{x}{\in \Rgez^n}
\end{mini}

$$A = \begin{bmatrix}\mathbf{A} & \bm{0} \\ \mathbf{I} & \mathbf{I}\end{bmatrix} ~~~|~~~ x = \begin{bmatrix}\mathbf{x} \\ \mathbf{x}_u\end{bmatrix} ~~~|~~~ b = \begin{bmatrix}\mathbf{b} \\ \mathbf{u}\end{bmatrix} ~~~|~~~ c = \begin{bmatrix}\mathbf{c} \\ \bm{0}\end{bmatrix}$$

\subsubsection{Dual}

\begin{maxi}|s|
{}{b^Ty}{}{}
\addConstraint{A^T\lambda + s}{= c}
\addConstraint{\lambda, s}{\in \R^m, \Rgez^n}
\end{maxi}

$$A = \begin{bmatrix}\mathbf{A} & \bm{0} \\ \mathbf{I} & \mathbf{I}\end{bmatrix} ~~~|~~~ \lambda = \begin{bmatrix}\mathbf{y} \\ \mathbf{y}_u\end{bmatrix} ~~~|~~~ b = \begin{bmatrix}\mathbf{b} \\ \mathbf{u}\end{bmatrix} ~~~|~~~ c = \begin{bmatrix}\mathbf{c} \\ \bm{0}\end{bmatrix} ~~~|~~~ s = \begin{bmatrix}\mathbf{z}_1 \\ \mathbf{z}_2\end{bmatrix}$$

\subsubsection{Big KKT}

$$\begin{bmatrix}
0 & A^T & I \\
A & 0 & 0 \\
S & 0 & X
\end{bmatrix}
\begin{bmatrix}d_x \\ d_y \\ d_s\end{bmatrix} = 
\begin{bmatrix}-r_d \\ -r_p \\ -r_c\end{bmatrix}$$

\subsubsection{Small KKT}

$$\begin{bmatrix}-X^{-1}S & A^T \\ A & 0\end{bmatrix}
\begin{bmatrix}d_x \\ d_y\end{bmatrix} = 
\begin{bmatrix}-r_d + X^{-1}r_c \\ -r_p\end{bmatrix}$$
$$d_s = -X^{-1}(r_c + Sd_x)$$

\subsubsection{No KKT}

Let $M := AS^{-1}XA^T$ (note: this is \emph{not necessarily} a Laplacian). Then,
\begin{align*}
d_y &= M^+(-r_p - AS^{-1}Xr_d + AS^{-1}r_c) \\
d_x &= -S^{-1}(r_c - X(r_d + A^Td-y))\\
d_s &= -X^{-1}(r_c + Sd_x)
\end{align*}

\subsubsection{Approximate KKT}

Substituting in the \texttt{Small KKT} system,
\begin{align*}
\begin{bmatrix}
-\mathbf{X}^{-1}\mathbf{S} & 0 & \mathbf{A}^T & I\\
0 & -\mathbf{X}_u^{-1}\mathbf{S}_u & 0 & I\\
\mathbf{A} & 0 & 0 & 0 \\
I & I & 0 & 0
\end{bmatrix}
\begin{bmatrix}d_x \\ d_{xu} \\ d_y \\ d_{yu}\end{bmatrix} &= 
\begin{bmatrix}
-r_d + \mathbf{X}^{-1}r_c \\
-r_{du} + \mathbf{X}_u^{-1}r_{cu} \\
-r_p \\
-r_{pu}
\end{bmatrix} \\
\intertext{Scaling:}
\begin{bmatrix}
I & 0 & -\mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T & -\mathbf{S}^{-1}\mathbf{X} \\
0 & I & 0 & -\mathbf{S}_u^{-1}\mathbf{X}_u \\
\mathbf{A} & 0 & 0 & 0 \\
I & I & 0 & 0
\end{bmatrix}
\begin{bmatrix}d_x \\ d_{xu} \\ d_y \\ d_{yu}\end{bmatrix} &= 
\begin{bmatrix}
\mathbf{S}^{-1}(\mathbf{X}r_d - r_c) \\
\mathbf{S}_u^{-1}(\mathbf{X}_ur_{du} - r_{cu}) \\
-r_p \\
-r_{pu}
\end{bmatrix} \\
\intertext{Eliminate $d_x$:}
\begin{bmatrix}
I & 0 & -\mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T & -\mathbf{S}^{-1}\mathbf{X} \\
0 & I & 0 & -\mathbf{S}_u^{-1}\mathbf{X}_u \\
0 & 0 & \mathbf{A}\mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T & \mathbf{A}\mathbf{S}^{-1}\mathbf{X} \\
0 & I & \mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T & \mathbf{S}^{-1}\mathbf{X}
\end{bmatrix}
\begin{bmatrix}d_x \\ d_{xu} \\ d_y \\ d_{yu}\end{bmatrix} &= 
\begin{bmatrix}
\mathbf{S}^{-1}(\mathbf{X}r_d - r_c) \\
\mathbf{S}_u^{-1}(\mathbf{X}_ur_{du} - r_{cu}) \\
-r_p - \mathbf{A}\mathbf{S}^{-1}(\mathbf{X}r_d - r_c) \\
-r_{pu} - \mathbf{S}^{-1}(\mathbf{X}r_d - r_c)
\end{bmatrix} \\
\intertext{Eliminate $d_{xu}$:}
\begin{bmatrix}
I & 0 & -\mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T & -\mathbf{S}^{-1}\mathbf{X} \\
0 & I & 0 & -\mathbf{S}_u^{-1}\mathbf{X}_u \\
0 & 0 & \mathbf{A}\mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T & \mathbf{A}\mathbf{S}^{-1}\mathbf{X} \\
0 & 0 & \mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T & \mathbf{S}^{-1}\mathbf{X}+\mathbf{S}_u^{-1}\mathbf{X}_u
\end{bmatrix}
\begin{bmatrix}d_x \\ d_{xu} \\ d_y \\ d_{yu}\end{bmatrix} &= 
\begin{bmatrix}
\mathbf{S}^{-1}(\mathbf{X}r_d - r_c) \\
\mathbf{S}_u^{-1}(\mathbf{X}_ur_{du} - r_{cu}) \\
-r_p - \mathbf{A}\mathbf{S}^{-1}(\mathbf{X}r_d - r_c) \\
-r_{pu} - \mathbf{S}^{-1}(\mathbf{X}r_d - r_c) - \mathbf{S}_u^{-1}(\mathbf{X}_ur_{du} - r_{cu})
\end{bmatrix} \\
\intertext{Let $\mathbf{K} := \mathbf{S}^{-1}\mathbf{X}+\mathbf{S}_u^{-1}\mathbf{X}_u$ and $r_q := -r_{pu} - \mathbf{S}^{-1}(\mathbf{X}r_d - r_c) - \mathbf{S}_u^{-1}(\mathbf{X}_ur_{du} - r_{cu})$:}
\begin{bmatrix}
I & 0 & -\mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T & -\mathbf{S}^{-1}\mathbf{X} \\
0 & I & 0 & -\mathbf{S}_u^{-1}\mathbf{X}_u \\
0 & 0 & \mathbf{A}\mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T & \mathbf{A}\mathbf{S}^{-1}\mathbf{X} \\
0 & 0 & \mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T & \mathbf{K}
\end{bmatrix}
\begin{bmatrix}d_x \\ d_{xu} \\ d_y \\ d_{yu}\end{bmatrix} &= 
\begin{bmatrix}
\mathbf{S}^{-1}(\mathbf{X}r_d - r_c) \\
\mathbf{S}_u^{-1}(\mathbf{X}_ur_{du} - r_{cu}) \\
-r_p - \mathbf{A}\mathbf{S}^{-1}(\mathbf{X}r_d - r_c) \\
r_q
\end{bmatrix} \\
\intertext{Swapping $d_y$ and $d_{yu}$:}
\begin{bmatrix}
I & 0 & -\mathbf{S}^{-1}\mathbf{X} & -\mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T \\
0 & I & -\mathbf{S}_u^{-1}\mathbf{X}_u & 0 \\
0 & 0 & \mathbf{K} & \mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T \\
0 & 0 & \mathbf{A}\mathbf{S}^{-1}\mathbf{X} & \mathbf{A}\mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T
\end{bmatrix}
\begin{bmatrix}d_x \\ d_{xu} \\ d_{yu} \\ d_y\end{bmatrix} &= 
\begin{bmatrix}
\mathbf{S}^{-1}(\mathbf{X}r_d - r_c) \\
\mathbf{S}_u^{-1}(\mathbf{X}_ur_{du} - r_{cu}) \\
r_q \\
-r_p - \mathbf{A}\mathbf{S}^{-1}(\mathbf{X}r_d - r_c)
\end{bmatrix} \\
\intertext{Pretending that $\mathbf{K}$ is invertible, and scaling:}
\begin{bmatrix}
I & 0 & -\mathbf{S}^{-1}\mathbf{X} & -\mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T \\
0 & I & -\mathbf{S}_u^{-1}\mathbf{X}_u & 0 \\
0 & 0 & I & \mathbf{K}^{-1}\mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T \\
0 & 0 & \mathbf{A}\mathbf{S}^{-1}\mathbf{X} & \mathbf{A}\mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T
\end{bmatrix}
\begin{bmatrix}d_x \\ d_{xu} \\ d_{yu} \\ d_y\end{bmatrix} &= 
\begin{bmatrix}
\mathbf{S}^{-1}(\mathbf{X}r_d - r_c) \\
\mathbf{S}_u^{-1}(\mathbf{X}_ur_{du} - r_{cu}) \\
\mathbf{K}^{-1}r_q \\
-r_p - \mathbf{A}\mathbf{S}^{-1}(\mathbf{X}r_d - r_c)
\end{bmatrix} \\
\intertext{Eliminating $d_{yu}$:}
\begin{bmatrix}
I & 0 & -\mathbf{S}^{-1}\mathbf{X} & -\mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T \\
0 & I & -\mathbf{S}_u^{-1}\mathbf{X}_u & 0 \\
0 & 0 & I & \mathbf{K}^{-1}\mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T \\
0 & 0 & 0 & \mathbf{A}(\mathbf{S}^{-1}\mathbf{X} - \mathbf{S}^{-1}\mathbf{X}\mathbf{K}^{-1}\mathbf{S}^{-1}\mathbf{X})\mathbf{A}^T
\end{bmatrix}
\begin{bmatrix}d_x \\ d_{xu} \\ d_{yu} \\ d_y\end{bmatrix} &= 
\begin{bmatrix}
\mathbf{S}^{-1}(\mathbf{X}r_d - r_c) \\
\mathbf{S}_u^{-1}(\mathbf{X}_ur_{du} - r_{cu}) \\
\mathbf{K}^{-1}r_q \\
-r_p - \mathbf{A}\mathbf{S}^{-1}(\mathbf{X}r_d - r_c + \mathbf{X}\mathbf{K}^{-1}r_q)
\end{bmatrix} \\
\intertext{Let $\mathbf{D} := \mathbf{S}^{-1}\mathbf{X} - \mathbf{S}^{-1}\mathbf{X}\mathbf{K}^{-1}\mathbf{S}^{-1}\mathbf{X} = \mathbf{S}^{-1}\mathbf{X}(I - \mathbf{K}^{-1}\mathbf{S}^{-1}\mathbf{X})$ and $\mathbf{L} := \mathbf{A}\mathbf{D}\mathbf{A}^T$ and $r_s := -r_p - \mathbf{A}\mathbf{S}^{-1}(\mathbf{X}r_d - r_c + \mathbf{X}\mathbf{K}^{-1}r_q)$:}
\begin{bmatrix}
I & 0 & -\mathbf{S}^{-1}\mathbf{X} & -\mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T \\
0 & I & -\mathbf{S}_u^{-1}\mathbf{X}_u & 0 \\
0 & 0 & I & \mathbf{K}^{-1}\mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T \\
0 & 0 & 0 & \mathbf{L}
\end{bmatrix}
\begin{bmatrix}d_x \\ d_{xu} \\ d_{yu} \\ d_y\end{bmatrix} &= 
\begin{bmatrix}
\mathbf{S}^{-1}(\mathbf{X}r_d - r_c) \\
\mathbf{S}_u^{-1}(\mathbf{X}_ur_{du} - r_{cu}) \\
\mathbf{K}^{-1}r_q \\
r_s
\end{bmatrix} \\
\intertext{Pretending that $\mathbf{L}$ is invertible:}
\begin{bmatrix}
I & 0 & -\mathbf{S}^{-1}\mathbf{X} & -\mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T \\
0 & I & -\mathbf{S}_u^{-1}\mathbf{X}_u & 0 \\
0 & 0 & I & \mathbf{K}^{-1}\mathbf{S}^{-1}\mathbf{X}\mathbf{A}^T \\
0 & 0 & 0 & I
\end{bmatrix}
\begin{bmatrix}d_x \\ d_{xu} \\ d_{yu} \\ d_y\end{bmatrix} &= 
\begin{bmatrix}
\mathbf{S}^{-1}(\mathbf{X}r_d - r_c) \\
\mathbf{S}_u^{-1}(\mathbf{X}_ur_{du} - r_{cu}) \\
\mathbf{K}^{-1}r_q \\
\mathbf{L}^{-1}r_s
\end{bmatrix} \\
\intertext{Eliminating $d_y$,}
\begin{bmatrix}
I & 0 & -\mathbf{S}^{-1}\mathbf{X} & 0 \\
0 & I & -\mathbf{S}_u^{-1}\mathbf{X}_u & 0 \\
0 & 0 & I & 0 \\
0 & 0 & 0 & I
\end{bmatrix}
\begin{bmatrix}d_x \\ d_{xu} \\ d_{yu} \\ d_y\end{bmatrix} &= 
\begin{bmatrix}
\mathbf{S}^{-1}(\mathbf{X}r_d - r_c + \mathbf{X}\mathbf{A}^Td_y) \\
\mathbf{S}_u^{-1}(\mathbf{X}_ur_{du} - r_{cu}) \\
\mathbf{K}^{-1}(r_q - \mathbf{S}^{-1}\mathbf{X}\mathbf{A}^Td_y) \\
\mathbf{L}^{-1}r_s
\end{bmatrix} \\
\intertext{Eliminating $d_{yu}$,}
\begin{bmatrix}
I & 0 & 0 & 0 \\
0 & I & 0 & 0 \\
0 & 0 & I & 0 \\
0 & 0 & 0 & I
\end{bmatrix}
\begin{bmatrix}d_x \\ d_{xu} \\ d_{yu} \\ d_y\end{bmatrix} &= 
\begin{bmatrix}
\mathbf{S}^{-1}(\mathbf{X}(r_d + \mathbf{A}^Td_y + d_{yu}) - r_c) \\
\mathbf{S}_u^{-1}(\mathbf{X}_u(r_{du} + d_{yu}) - r_{cu}) \\
\mathbf{K}^{-1}(r_q - \mathbf{S}^{-1}\mathbf{X}\mathbf{A}^Td_y) \\
\mathbf{L}^{-1}r_s
\end{bmatrix}
\end{align*}

In summary, we want the following steps:
\begin{itemize}
\item \texttt{k = x ./ s + xu ./ su}
\item \texttt{rq = -rpu - (x .* rd - rc) ./ s - (xu .* rdu - rcu) ./ su}
\item \texttt{d = x .* (1 .- x ./ (k .* s)) ./ s}
\item \texttt{L = A * diag(d) * A'}
\item \texttt{rs = -rp - A * ((x .* (rd + rq ./ k) - rc) ./ s)}
\item \texttt{dy = inv(L) * rs}
\item \texttt{dyu = (rq - (A' * dy) .* x ./ s) ./ k}
\item \texttt{dxu = (xu .* (rdu + dyu) - rcu) ./ su}
\item \texttt{dx = (x .* (rd + A' * dy + dyu) - rc) ./ su}
\end{itemize}

\end{document}